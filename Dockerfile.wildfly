FROM quay.io/wildfly/wildfly:31.0.0.Final

# Установка необходимых утилит
USER root
RUN microdnf install -y curl unzip && microdnf clean all
USER wildfly

# Копирование зависимостей
COPY --chown=wildfly:wildfly lib/mariadb-java-client-3.3.2.jar /tmp/
COPY --chown=wildfly:wildfly lib/keycloak-*.jar /tmp/

# Копирование CLI скриптов
COPY --chown=wildfly:wildfly wildfly-config/*.cli /wildfly-config/

# Выполнение CLI скриптов
RUN /opt/jboss/wildfly/bin/jboss-cli.sh --file=/wildfly-config/configure-datasource.cli && \
    /opt/jboss/wildfly/bin/jboss-cli.sh --file=/wildfly-config/configure-keycloak.cli

# Копирование приложения
COPY --chown=wildfly:wildfly target/hotel-api.war /opt/jboss/wildfly/standalone/deployments/

# Конфигурация Keycloak
COPY --chown=wildfly:wildfly src/main/resources/keycloak.json /opt/jboss/wildfly/standalone/configuration/

# Добавляем health check endpoint
COPY --chown=wildfly:wildfly src/main/java/ru/gitverse/hotelapi/rest/HealthResource.java /opt/jboss/wildfly/health-resource/

# Запуск сервера
CMD ["/opt/jboss/wildfly/bin/standalone.sh", "-b", "0.0.0.0", "-bmanagement", "0.0.0.0"]